# 暖遇 (Warm Connect) - 开发设计文档

## 1. 项目概述 (Project Overview)
**暖遇** 是一款专为肿瘤患者及其家属设计的基于地理位置（LBS）的轻社交应用。
- **核心价值**：打破医院内孤岛，在低心理负担、高安全感的前提下，连接同病相怜的伙伴。
- **视觉风格**：温暖、克制、生命力。以淡绿色 (#53C9B1) 为主色，橙色 (#FF724C) 为点缀。

---

## 2. 技术栈 (Tech Stack)
- **前端框架**：React 19 (ES6 Modules)
- **样式处理**：Tailwind CSS (响应式、移动优先)
- **后端服务**：Supabase (提供实时数据库与数据持久化)
- **人工智能**：Google Gemini API (用于生成破冰语与每日鼓励语)
- **图标系统**：Lucide React
- **地理位置**：浏览器 Geolocation API

---

## 3. 核心功能逻辑 (Core Logic)

### 3.1 用户体系
- **匿名轻量化**：通过浏览器 `localStorage` 存储 `user_id`，实现无感知登录。
- **身份标签**：分为“患者”、“家属”、“志愿者”，确保互助的精准性。
- **地理脱敏**：用户可手动校准位置，通过 `location_name`（如“A座5层”）而非具体坐标进行初步交流。

### 3.2 约见闭环 (Meetup Workflow)
1.  **搜寻**：从 Supabase 获取周围 `is_visible: true` 的用户。
2.  **破冰**：调用 Gemini 根据双方身份和对方当前状态生成“暖心话语”。
3.  **发送**：在 `meetup_requests` 表中创建状态为 `pending` 的记录。
4.  **通知**：接收方在“约见状态箱”看到新请求。
5.  **决策**：
    - **确认接受**：状态更新为 `accepted`，双方可见对方微信号。
    - **我想想**：状态更新为 `rejected` 或删除。
6.  **跳转**：接受后，提供“复制并打开微信”功能，通过 `weixin://` 协议尝试唤起微信。
7.  **清理**：用户可随时删除已发送或收到的往来记录，保护隐私并保持界面整洁。
8.  **隐藏伙伴**：在发现页，用户可以“删除（隐藏）”不感兴趣或已打过招呼的伙伴，该操作通过本地 `ignoredUserIds` 状态实现，不影响对方账号状态。

### 3.3 图标实验室 (Logo Lab)
- 支持用户上传图片作为应用的临时 Logo，增加互动的趣味性与个性化归属感。

---

## 4. 数据库设计 (Database Schema)

### Table: `profiles`
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | uuid | 主键 |
| nickname | text | 用户昵称 |
| wechat_id | text | 微信号 (隐私敏感) |
| role | text | 身份 (患者/家属) |
| status | text | 当前状态/心境 |
| location_name| text | 位置描述 |
| last_lat/lng | float | 最后已知坐标 |
| is_visible | boolean | 广场可见性 |
| avatar | text | 头像 URL |

### Table: `meetup_requests`
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | uuid | 主键 |
| from_user_id | uuid | 发起方 ID |
| to_user_id | uuid | 接收方 ID |
| status | text | pending / accepted / rejected |
| message | text | 破冰语内容 |

---

## 5. AI 提示词工程 (AI Prompt Engineering)

### 破冰语生成 (`getIceBreaker`)
- **模型**：`gemini-3-flash-preview`
- **系统指令**：你是一个温柔、充满同理心的患友互助助手。
- **输入参数**：我的身份、对方身份、对方状态。
- **输出要求**：50字以内，无说教感，低社交压力。

### 每日鼓励语 (`getDailyEncouragement`)
- **目标**：提供非陈词滥调的情感支持。

---

## 6. 开发注意事项 (Development Notes)
1.  **隐私保护**：WeChat ID 严禁在广场接口中暴露，仅在 `meetup_requests` 状态为 `accepted` 时，通过关联查询有条件地展示给相关方。
2.  **数据清理**：物理删除 `meetup_requests` 记录时，确保 UI 逻辑同步处理 `selectedRequest` 状态，避免引用已不存在的数据。
3.  **本地存储**：`ignoredUserIds` 存储在 `localStorage` 中，用于维持用户在同一设备上的发现页清理状态。

---
*Generated by Warm Connect Engineering Team*
